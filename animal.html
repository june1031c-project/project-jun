<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
  <link href='/style.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</h1>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="í…Œë§ˆ ë³€ê²½">
        <span class="icon-sun">â˜€ï¸</span>
        <span class="icon-moon">ğŸŒ™</span>
      </button>
    </header>
    <p class="subtitle">AIê°€ ë‹¹ì‹ ì˜ ë™ë¬¼ìƒì„ ì•Œë ¤ë“œë ¤ìš”</p>

    <nav class="nav-bar">
      <a href="/index.html" class="nav-link">ğŸ± ë¡œë˜</a>
      <a href="/dinner.html" class="nav-link">ğŸ½ï¸ ë©”ë‰´</a>
      <a href="/animal.html" class="nav-link active">ğŸ¾ ë™ë¬¼ìƒ</a>
      <a href="/contact.html" class="nav-link">ğŸ“© ë¬¸ì˜</a>
    </nav>

    <div class="animal-result-box" id="resultBox">
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div class="upload-placeholder" id="uploadPlaceholder">
          <span class="upload-icon">ğŸ“·</span>
          <span class="upload-text">ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</span>
        </div>
        <img class="preview-img hidden" id="previewImg" alt="ì—…ë¡œë“œëœ ì‚¬ì§„">
      </div>
      <input type="file" id="fileInput" accept="image/*" class="hidden">

      <div class="animal-result hidden" id="animalResult">
        <span class="animal-emoji" id="animalEmoji"></span>
        <span class="animal-label" id="animalLabel"></span>
        <div class="animal-bars" id="animalBars"></div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="analyzeBtn" disabled onclick="analyze()">
        <span class="btn-icon">ğŸ”</span> ë¶„ì„í•˜ê¸°
      </button>
      <button class="btn btn-secondary" onclick="reset()">
        <span class="btn-icon">ğŸ”„</span> ë‹¤ì‹œí•˜ê¸°
      </button>
    </div>

    <div class="disqus-section">
      <h2 class="disqus-title">ëŒ“ê¸€</h2>
      <div id="disqus_thread"></div>
    </div>
  </div>

  <script>
    // Theme
    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
    })();

    // Teachable Machine
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/Q_3YX-pyr/";
    let model, maxPredictions;

    const animalMap = {
      'ê°•ì•„ì§€': { emoji: 'ğŸ¶', desc: 'ê°•ì•„ì§€ìƒ' },
      'ê³ ì–‘ì´': { emoji: 'ğŸ±', desc: 'ê³ ì–‘ì´ìƒ' },
    };

    // Load model on page load
    (async function loadModel() {
      model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
      maxPredictions = model.getTotalClasses();
    })();

    // File input
    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const uploadArea = document.getElementById('uploadArea');
    const analyzeBtn = document.getElementById('analyzeBtn');

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      showPreview(file);
    });

    // Drag & drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) showPreview(file);
    });

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.classList.remove('hidden');
        uploadPlaceholder.classList.add('hidden');
        analyzeBtn.disabled = false;
        document.getElementById('animalResult').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }

    async function analyze() {
      if (!model) {
        analyzeBtn.innerHTML = '<span class="btn-icon">â³</span> ëª¨ë¸ ë¡œë”© ì¤‘...';
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        maxPredictions = model.getTotalClasses();
      }

      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<span class="btn-icon">â³</span> ë¶„ì„ ì¤‘...';

      const prediction = await model.predict(previewImg);

      let best = prediction[0];
      for (const p of prediction) {
        if (p.probability > best.probability) best = p;
      }

      const mapped = animalMap[best.className] || { emoji: 'ğŸ¾', desc: best.className };
      document.getElementById('animalEmoji').textContent = mapped.emoji;
      document.getElementById('animalLabel').textContent = mapped.desc;

      const barsEl = document.getElementById('animalBars');
      barsEl.innerHTML = '';
      for (let i = 0; i < maxPredictions; i++) {
        const p = prediction[i];
        const pct = Math.round(p.probability * 100);
        const m = animalMap[p.className] || { emoji: 'ğŸ¾' };
        const row = document.createElement('div');
        row.className = 'bar-row';
        row.innerHTML = `
          <span class="bar-label">${m.emoji} ${p.className}</span>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
          <span class="bar-pct">${pct}%</span>
        `;
        barsEl.appendChild(row);
      }

      document.getElementById('animalResult').classList.remove('hidden');
      analyzeBtn.disabled = false;
      analyzeBtn.innerHTML = '<span class="btn-icon">ğŸ”</span> ë¶„ì„í•˜ê¸°';
    }

    function reset() {
      fileInput.value = '';
      previewImg.src = '';
      previewImg.classList.add('hidden');
      uploadPlaceholder.classList.remove('hidden');
      document.getElementById('animalResult').classList.add('hidden');
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<span class="btn-icon">ğŸ”</span> ë¶„ì„í•˜ê¸°';
    }

    // Disqus
    var disqus_config = function () {
      this.page.url = location.href;
      this.page.identifier = 'animal';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://junhae.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</body>
</html>
