<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
  <link href='/style.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</h1>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="í…Œë§ˆ ë³€ê²½">
        <span class="icon-sun">â˜€ï¸</span>
        <span class="icon-moon">ğŸŒ™</span>
      </button>
    </header>
    <p class="subtitle">AIê°€ ë‹¹ì‹ ì˜ ë™ë¬¼ìƒì„ ì•Œë ¤ë“œë ¤ìš”</p>

    <nav class="nav-bar">
      <a href="/index.html" class="nav-link">ğŸ± ë¡œë˜</a>
      <a href="/dinner.html" class="nav-link">ğŸ½ï¸ ë©”ë‰´</a>
      <a href="/animal.html" class="nav-link active">ğŸ¾ ë™ë¬¼ìƒ</a>
      <a href="/contact.html" class="nav-link">ğŸ“© ë¬¸ì˜</a>
    </nav>

    <div class="animal-result-box" id="resultBox">
      <div class="placeholder" id="placeholder">ì¹´ë©”ë¼ë¥¼ ì¼œê³  ë™ë¬¼ìƒì„ í™•ì¸í•˜ì„¸ìš”</div>

      <div class="webcam-wrapper hidden" id="webcamWrapper">
        <div id="webcam-container"></div>
      </div>

      <div class="animal-result hidden" id="animalResult">
        <span class="animal-emoji" id="animalEmoji"></span>
        <span class="animal-label" id="animalLabel"></span>
        <div class="animal-bars" id="animalBars"></div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="startBtn" onclick="init()">
        <span class="btn-icon">ğŸ“·</span> ì¹´ë©”ë¼ ì‹œì‘
      </button>
      <button class="btn btn-secondary hidden" id="stopBtn" onclick="stop()">
        <span class="btn-icon">â¹ï¸</span> ì¹´ë©”ë¼ ì¢…ë£Œ
      </button>
    </div>

    <div class="disqus-section">
      <h2 class="disqus-title">ëŒ“ê¸€</h2>
      <div id="disqus_thread"></div>
    </div>
  </div>

  <script>
    // Theme
    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
    })();

    // Teachable Machine
    const URL = "https://teachablemachine.withgoogle.com/models/Q_3YX-pyr/";
    let model, webcam, maxPredictions;
    let running = false;

    const animalMap = {
      'ê°•ì•„ì§€': { emoji: 'ğŸ¶', desc: 'ê°•ì•„ì§€ìƒ' },
      'ê³ ì–‘ì´': { emoji: 'ğŸ±', desc: 'ê³ ì–‘ì´ìƒ' },
    };

    async function init() {
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      startBtn.disabled = true;
      startBtn.innerHTML = '<span class="btn-icon">â³</span> ë¡œë”© ì¤‘...';

      try {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const flip = true;
        webcam = new tmImage.Webcam(280, 280, flip);
        await webcam.setup();
        await webcam.play();
        running = true;

        document.getElementById('placeholder').classList.add('hidden');
        const webcamWrapper = document.getElementById('webcamWrapper');
        webcamWrapper.classList.remove('hidden');
        document.getElementById('webcam-container').appendChild(webcam.canvas);
        document.getElementById('animalResult').classList.remove('hidden');

        // Build bar UI
        const barsEl = document.getElementById('animalBars');
        barsEl.innerHTML = '';
        for (let i = 0; i < maxPredictions; i++) {
          const row = document.createElement('div');
          row.className = 'bar-row';
          row.innerHTML = `
            <span class="bar-label" id="barLabel${i}"></span>
            <div class="bar-track"><div class="bar-fill" id="barFill${i}"></div></div>
            <span class="bar-pct" id="barPct${i}"></span>
          `;
          barsEl.appendChild(row);
        }

        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        window.requestAnimationFrame(loop);
      } catch (e) {
        alert('ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        startBtn.disabled = false;
        startBtn.innerHTML = '<span class="btn-icon">ğŸ“·</span> ì¹´ë©”ë¼ ì‹œì‘';
      }
    }

    async function loop() {
      if (!running) return;
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      let best = prediction[0];
      for (const p of prediction) {
        if (p.probability > best.probability) best = p;
      }

      const mapped = animalMap[best.className] || { emoji: 'ğŸ¾', desc: best.className };
      document.getElementById('animalEmoji').textContent = mapped.emoji;
      document.getElementById('animalLabel').textContent = mapped.desc;

      for (let i = 0; i < maxPredictions; i++) {
        const p = prediction[i];
        const pct = Math.round(p.probability * 100);
        const m = animalMap[p.className] || { emoji: 'ğŸ¾' };
        document.getElementById(`barLabel${i}`).textContent = `${m.emoji} ${p.className}`;
        document.getElementById(`barFill${i}`).style.width = pct + '%';
        document.getElementById(`barPct${i}`).textContent = pct + '%';
      }
    }

    function stop() {
      running = false;
      if (webcam) {
        webcam.stop();
      }
      document.getElementById('webcam-container').innerHTML = '';
      document.getElementById('webcamWrapper').classList.add('hidden');
      document.getElementById('animalResult').classList.add('hidden');
      document.getElementById('placeholder').classList.remove('hidden');

      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      startBtn.classList.remove('hidden');
      startBtn.disabled = false;
      startBtn.innerHTML = '<span class="btn-icon">ğŸ“·</span> ì¹´ë©”ë¼ ì‹œì‘';
      stopBtn.classList.add('hidden');
    }

    // Disqus
    var disqus_config = function () {
      this.page.url = location.href;
      this.page.identifier = 'animal';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://junhae.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</body>
</html>
